# 原理

​	虚机备份记录的是虚机在某一特定时间内的一个具有只读属性的镜像文件（不包含内存信息），就是将虚机各项（非实时）信息和磁盘状态保存下来。如果虚机故障或者数据意外被删除，可以使用备份恢复技术恢复到特定时刻。

​	创建虚机备份，虚拟机处于运行或者关闭态均可（虚机快照则要求包含内存信息，即虚机需要处于运行态）。备份即全量克隆。

​	注：克隆分为全量克隆和增量克隆，增量的就是在快照上写时复制（cow=copy on write，此时不脱离与父节点的关系，需要依赖于父节点存在），全量则是flatten之后脱离与父亲节点的联系。

# 分类

​	创建虚机备份，包括全量备份和增量备份。

​	全量备份就是合并原来的所有节点（需要合并多个节点，因为每个节点上存储的都只是一部分信息），如果想要全部备份到目的节点需要从虚机运行的叶子节点开始合并原来的若干节点，然后全部赋值到目的backup节点。

​	增量备份就是在虚机原来的节点上拉出来一个运行的叶子节点和备份节点，然后备份节点指向原来的父节点即可，这样的操作非常迅速。

# 在线全量

## qcow2

​	针对qcow2格式的磁盘文件，基本的备份方法如下：

​	1、在执行的备份存储库上创建备份的磁盘文件；

​	2、创建虚机磁盘的新的叶子节点；

​	3、虚机执行快照操作；

​	（1）qemu-img rebase –f qcow2 –b 虚机磁盘原叶子节点路径 –F qcow2 –u 虚机磁盘新叶子节点路径；

​	（2）virsh –k 0 snapshot-create-as 虚机运行时的domid –disk-only 

–diskspec 虚拟机原磁盘1名, file=虚机原磁盘1新叶子节点路径

–diskspec 虚拟机原磁盘2名, file=虚机原磁盘2新叶子节点路径

--diskspec……

--reuse-external –no-metadata

​	4、处理虚机磁盘新叶子节点和磁盘的关系，将新叶子节点及其所有的父节点合并到目的全量磁盘节点中：

​	qemu-img convert –O qcow2 虚机某磁盘原叶子路径 备份磁盘文件路径

​	5、自动压缩全量备份磁盘节点；

​	6、合并虚机磁盘文件。

 

## rbd

# 在线增量

## qcow2

## rbd

# 离线全量

## qcow2

## rbd

# 离线增量

## qcow2

## rbd

 