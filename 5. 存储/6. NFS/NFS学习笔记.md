# 原理

NFS的主要功能是通过网络让不同的机器系统之间可以彼此共享文件和目录。NFS服务器可以允许NFS客户端将远端NFS服务器端的共享目录挂载到本地的NFS客户端中。在本地的NFS客户端的机器看来，NFS服务器共享的目录就好像自己的磁盘分区和目录一样。一般客户端挂载到本地目录的名字可以随便，但是为了方便管理，我们要和服务器端的一样比较好。

NFS一般用于存储共享视频、图片、文件等静态数据。

**挂载结构体：**

![img](file:///C:\Users\大力\AppData\Local\Temp\ksohtml\wpsBE67.tmp.jpg) 

​	如果服务器端配置的客户端只读，那么客户端就只能够只读。如果配置读写，客户端就可以读写。

挂载后，客户端查看磁盘信息的命令：df -h

# RPC协议

NFS是通过网络来进行服务器和客户端之间的数据传输。

两者之间要传输数据就要有相对应的网络端口来进行传输，NFS服务器到底使用什么网络端口传输数据的呢，其实服务器端是随机选择端口来进行数据传输的。

那么NFS客户端又是如何知道NFS服务器端到底使用的是哪个端口的呢？其实，**NFS服务器是通过远程过程调用（remote** **procedure** **call****，简称rpc）协议/服务来实现的**。也就是说，RPC服务会统一管理NFS端口，客户端和服务器通过RPC来先沟通NFS使用了哪些端口，之后再利用这些端口（小于1024）来进行数据的传输。

RPC管理服务端的NFS端口分配，客户端要传数据，那客户端的RPC会先跟服务端的RPC去要服务器的端口，要到端口后建立连接，然后传输数据。

PC（portmap）就是用来统一管理NFS端口的服务，并且统一对外的端口是111.NFS服务端需要先启动RPC，再启动NFS，这样NFS才能够到RPC去注册接口信息。客户端的RPC可以通过向服务端的RPC请求获取服务端的NFS端口信息。当获取到了NFS端口信息后，就会以实际端口进行数据的传输。

因为NFS有很多功能，不同的功能需要使用不同的端口。因此NFS无法固定端口。而RPC会记录NFS端口的信息，这样我们就能够通过RPC实现客户端和服务端的RPC沟通端口信息。

在启动NFS Server之前，首先要启动RPC服务（即portmap服务），否则NFS Server就无法向RPC服务注册。另外，如果RPC服务重新启动，原来已经注册好的NFS端口数据就会全部丢失。因此，此时RPC服务管理的NFS程序也要重新启动以重新向RPC注册。

说明：一般修改NFS配置后，是不需要重启NFS的，直接在命令行下手动执行/etc/init.d/nfs reload或exportfs –rv即可使修改的/etc/exports生效。

# 通讯过程

![img](file:///C:\Users\大力\AppData\Local\Temp\ksohtml\wpsBE78.tmp.jpg) 

基本过程：

1、 首先服务器端启动RPC服务，并开启111端口

2、 启动NFS服务，并向RPC注册端口信息

3、 客户端启动RPC（portmap服务），向服务端的RPC（portmap）服务请求服务器NFS端口

4、 服务端的RPC服务反馈NFS端口信息给客户端

5、 客户端通过获取NFS端口来建立和服务端的NFS连接并进行数据的传输

# 部署

## **客户端**

直接安装portmap和NFS软件即可。

## **服务端**

### **查看系统信息**

uname –r 查看系统内核版本

cat /etc/redhat-release 查看系统发行版本

uname –a 查看操作系统信息

注：要养成一个习惯，就是先查看系统版本和内核参数，同一个软件在不同版本、内核之间是有差异的，所以部署的方法也不一样，不要因为这个造成不必要的错误。在做应用迁移之前也要对环境系统做一个完整的登记，并且新环境中的一些参数要和旧环境一模一样避免错误。

### **NFS安装**

### **NFS启动**

因为NFS及其辅助程序都是基于RPC协议，所以首先要确保系统中运行了portmap服务。客户单和服务端都需要启动portmap服务，客户端不要启动NFS服务，服务器端需要启动NFS服务。

portmap启动命令：/etc/init.d/portmap start

使用netstate –lnt查看系统中启用的端口（直接使用netstate命令看不到端口）

### **配置开机自启动**

# 配置

## **配置文件路径**

**格式：**NFS共享目录	客户端地址1（参数1，参数2[只读/可写]）

参数说明：

**共享目录：**存在于我们本机上的目录，我们想共享给网络上的其他主机使用

客户端地址1（参数1，参数2）：客户端地址能够设置一个网络，也可以设置单个主机，如果设置为*，则表示所有的主机都可以访问

**参数：**如读写权限rw，同步更新sync，压缩来访账号all_squash，非root不压缩no_root_squash，压缩后的匿名账号anonuid=uid,anongid=gid等等。

**客户端地址选项说明：**

| 客户端地址            | 具体地址例子 | 说明                                                        |
| --------------------- | ------------ | ----------------------------------------------------------- |
| 授权单一客户端访问NFS | 10.0.0.30    | 一般情况，生产环境中此配置不多                              |
| 授权整个网段可访问NFS | 10.0.0.0/24  | 其中的/24表示掩码为255.255.255.0.在生产环境中最常见的配置。 |
| 授权整个网段          | 10.0.0.*     | 指定网段的另外写法（需要验证）                              |

## **配置权限**

rw	表示可读写

ro	Read-only表示只能读权限

sync	请求或者写入数据时，数据同步写入到NFS server硬盘中才会返回

no_root_squas	访问NFS server共享目录的用户如果是root，它对该目录具有root权限，这个配置原本为无盘用户准备的，用户应避免使用

root_squash	不管访问NFS server共享目录的用户身份如何包括root，它的权限都将被压缩成为匿名用户，同时他们的uid和gid都会变成nobody或nfsnobody账户的uid，gid。在多个NFS客户端同时读写NFS server数据时，这个参数很有用。

# 特点

## **优点**

## **缺点**

# 应用

# 故障

# 参考

https://blog.51cto.com/atong/1343950

 